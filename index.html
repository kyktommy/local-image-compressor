<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Compressor</title>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .upload-area {
            border: 3px dashed #4facfe;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            background: #f8fbff;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #00f2fe;
            background: #f0f9ff;
        }
        
        .upload-area.dragover {
            border-color: #00f2fe;
            background: #e6f7ff;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #4facfe;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 10px;
        }
        
        .upload-subtext {
            color: #666;
            font-size: 1rem;
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .settings {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .settings h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .setting-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }
        
        .setting-group label {
            min-width: 120px;
            font-weight: 500;
        }
        
        .setting-group input, .setting-group select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .file-list {
            margin-top: 30px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .file-preview {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .file-details h4 {
            margin-bottom: 5px;
            color: #333;
        }
        
        .file-details p {
            color: #666;
            font-size: 0.9rem;
        }

        .file-status {
            margin-top: 8px;
            font-size: 0.85rem;
        }

        .file-status.compressing {
            color: #4facfe;
            font-weight: 500;
        }

        .file-status.completed {
            color: #27ae60;
            font-weight: 500;
        }

        .file-status.error {
            color: #e74c3c;
            font-weight: 500;
        }

        .file-progress-bar {
            width: 100%;
            height: 4px;
            background: #e1e5e9;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 5px;
        }

        .file-progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.3s ease;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.3s ease;
        }
        
        .status {
            text-align: center;
            padding: 20px;
            font-size: 1.1rem;
            color: #333;
        }
        
        .error {
            color: #e74c3c;
            background: #fdf2f2;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .success {
            color: #27ae60;
            background: #f2fdf5;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="root">
        <svg class="loading-spinner" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><style>.spinner_9Mto{animation:spinner_5GqJ 1.6s linear infinite;animation-delay:-1.6s}.spinner_bb12{animation-delay:-1s}@keyframes spinner_5GqJ{12.5%{x:13px;y:1px}25%{x:13px;y:1px}37.5%{x:13px;y:13px}50%{x:13px;y:13px}62.5%{x:1px;y:13px}75%{x:1px;y:13px}87.5%{x:1px;y:1px}}</style><rect class="spinner_9Mto" x="1" y="1" rx="1" width="10" height="10"/><rect class="spinner_9Mto spinner_bb12" x="1" y="1" rx="1" width="10" height="10"/></svg>
    </div>

    <script type="text/babel" data-type="module">
        import React from "https://esm.sh/react@19";
        import ReactDOM from "https://esm.sh/react-dom@19/client";
        import * as jpegModule from "https://unpkg.com/@jsquash/jpeg?module";
        import * as pngModule from "https://unpkg.com/@jsquash/png?module";
        import * as oxipngModule from "https://unpkg.com/@jsquash/oxipng?module";
        import * as webpModule from "https://unpkg.com/@jsquash/webp?module";

        const { useState, useRef, useCallback } = React;

        function ImageCompressor() {
            const [files, setFiles] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [progress, setProgress] = useState(0);
            const [status, setStatus] = useState('');
            const [error, setError] = useState('');
            const [quality, setQuality] = useState(0.85);
            const [outputFormat, setOutputFormat] = useState('webp');
            const fileInputRef = useRef(null);

            const handleFileSelect = useCallback((selectedFiles) => {
                const imageFiles = Array.from(selectedFiles).filter(file => 
                    file.type.startsWith('image/')
                );
                
                if (imageFiles.length === 0) {
                    setError('Please select valid image files');
                    return;
                }
                
                setError('');
                const fileObjects = imageFiles.map(file => ({
                    file,
                    id: Math.random().toString(36).substr(2, 9),
                    name: file.name,
                    size: file.size,
                    preview: URL.createObjectURL(file),
                    status: 'pending', // pending, compressing, completed, error
                    progress: 0,
                    compressedSize: null,
                    savings: null,
                    error: null
                }));
                
                setFiles(prev => [...prev, ...fileObjects]);
            }, []);

            const handleDrop = useCallback((e) => {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
                handleFileSelect(e.dataTransfer.files);
            }, [handleFileSelect]);

            const handleDragOver = useCallback((e) => {
                e.preventDefault();
                e.currentTarget.classList.add('dragover');
            }, []);

            const handleDragLeave = useCallback((e) => {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
            }, []);

            const removeFile = useCallback((id) => {
                setFiles(prev => prev.filter(file => file.id !== id));
            }, []);

            const updateFileStatus = useCallback((fileId, updates) => {
                setFiles(prev => prev.map(file =>
                    file.id === fileId ? { ...file, ...updates } : file
                ));
            }, []);

            const formatFileSize = (bytes) => {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            };

            const compressImages = async () => {
                if (files.length === 0) {
                    setError('Please select images to compress');
                    return;
                }

                setIsProcessing(true);
                setError('');
                setProgress(0);
                setStatus('Initializing compression...');

                try {
                    const zip = new JSZip();
                    const compressedFiles = [];

                    for (let i = 0; i < files.length; i++) {
                        const fileObj = files[i];
                        setStatus(`Processing ${fileObj.name}... (${i + 1}/${files.length})`);

                        // Update file status to compressing
                        updateFileStatus(fileObj.id, {
                            status: 'compressing',
                            progress: 0
                        });

                        try {
                            // Read file as array buffer
                            updateFileStatus(fileObj.id, { progress: 20 });
                            const arrayBuffer = await fileObj.file.arrayBuffer();

                            // Decode based on original format
                            updateFileStatus(fileObj.id, { progress: 40 });
                            let imageData;
                            const fileType = fileObj.file.type;
                            
                            if (fileType.includes('jpeg') || fileType.includes('jpg')) {
                                imageData = await jpegModule.decode(arrayBuffer);
                            } else if (fileType.includes('png')) {
                                imageData = await pngModule.decode(arrayBuffer);
                            } else if (fileType.includes('webp')) {
                                imageData = await webpModule.decode(arrayBuffer);
                            } else {
                                // Fallback: try to decode as JPEG
                                imageData = await jpegModule.decode(arrayBuffer);
                            }

                            // Encode to desired format
                            updateFileStatus(fileObj.id, { progress: 60 });
                            let compressedBuffer;
                            let extension;
                            
                            if (outputFormat === 'webp') {
                                compressedBuffer = await webpModule.encode(imageData, { quality: quality * 100 });
                                extension = 'webp';
                            } else if (outputFormat === 'jpeg') {
                                compressedBuffer = await jpegModule.encode(imageData, { quality: quality * 100 });
                                extension = 'jpg';
                            } else if (outputFormat === 'png') {
                                compressedBuffer = await oxipngModule.optimise(imageData, { level: 4 - Math.round(quality * 3) });
                                extension = 'png';
                            } else {
                                compressedBuffer = await webpModule.encode(imageData, { quality: quality * 100 });
                                extension = 'webp';
                            }

                            // Generate filename
                            updateFileStatus(fileObj.id, { progress: 80 });
                            const originalName = fileObj.name.split('.').slice(0, -1).join('.');
                            const compressedName = `${originalName}_compressed.${extension}`;

                            // Add to ZIP
                            zip.file(compressedName, compressedBuffer);

                            // Calculate savings
                            const savings = ((fileObj.size - compressedBuffer.byteLength) / fileObj.size * 100).toFixed(1);

                            // Update file status to completed
                            updateFileStatus(fileObj.id, {
                                status: 'completed',
                                progress: 100,
                                compressedSize: compressedBuffer.byteLength,
                                savings: savings
                            });

                            compressedFiles.push({
                                original: fileObj,
                                compressed: {
                                    name: compressedName,
                                    size: compressedBuffer.byteLength
                                }
                            });

                        } catch (fileError) {
                            console.error(`Error processing ${fileObj.name}:`, fileError);
                            updateFileStatus(fileObj.id, {
                                status: 'error',
                                error: fileError.message
                            });
                            setError(prev => prev + `\nError processing ${fileObj.name}: ${fileError.message}`);
                        }

                        setProgress(((i + 1) / files.length) * 100);
                    }

                    if (compressedFiles.length === 0) {
                        throw new Error('No files were successfully processed');
                    }

                    setStatus('Creating ZIP file...');
                    
                    // Generate ZIP file
                    const zipBlob = await zip.generateAsync({ type: 'blob' });
                    
                    // Download ZIP
                    const url = URL.createObjectURL(zipBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `compressed_images_${new Date().toISOString()}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    setStatus(`Successfully compressed ${compressedFiles.length} images!`);
                    
                    // Calculate compression stats
                    const originalSize = compressedFiles.reduce((sum, f) => sum + f.original.size, 0);
                    const compressedSize = compressedFiles.reduce((sum, f) => sum + f.compressed.size, 0);
                    const savings = ((originalSize - compressedSize) / originalSize * 100).toFixed(1);
                    
                    setStatus(prev => prev + ` Original: ${formatFileSize(originalSize)}, Compressed: ${formatFileSize(compressedSize)}, Saved: ${savings}%`);

                } catch (err) {
                    console.error('Compression error:', err);
                    setError(`Compression failed: ${err.message}`);
                } finally {
                    setIsProcessing(false);
                }
            };

            return (
                <div className="container">
                    <div className="header">
                        <h1>üñºÔ∏è Image Compressor</h1>
                        <p>Compress multiple images and download as ZIP</p>
                    </div>

                    <div className="main-content">

                         <div 
                            className="upload-area"
                            onDrop={handleDrop}
                            onDragOver={handleDragOver}
                            onDragLeave={handleDragLeave}
                            onClick={() => fileInputRef.current?.click()}
                        >
                            <div className="upload-icon">üìÅ</div>
                            <div className="upload-text">Drop images here or click to select</div>
                            <div className="upload-subtext">Supports JPEG, PNG, WebP formats</div>
                        </div>

                        <div className="settings">
                            <h3>Compression Settings</h3>
                            <div className="setting-group">
                                <label>Output Format:</label>
                                <select 
                                    value={outputFormat} 
                                    onChange={(e) => setOutputFormat(e.target.value)}
                                    disabled={isProcessing}
                                >
                                    <option value="webp">WebP</option>
                                    <option value="jpeg">JPEG</option>
                                    <option value="png">PNG</option>
                                </select>
                            </div>
                            <div className="setting-group">
                                <label>Quality:</label>
                                <input
                                    type="range"
                                    min="0.05"
                                    max="1.0"
                                    step="0.05"
                                    value={quality}
                                    onChange={(e) => setQuality(parseFloat(e.target.value))}
                                    disabled={isProcessing}
                                />
                                <span>{Math.round(quality * 100)}%</span>
                            </div>
                        </div>

                        <input
                            ref={fileInputRef}
                            type="file"
                            multiple
                            accept="image/*"
                            className="file-input"
                            onChange={(e) => handleFileSelect(e.target.files)}
                        />

                        {files.length > 0 && (
                            <div className="file-list">
                                <h3>Selected Images ({files.length})</h3>
                                {files.map(file => (
                                    <div key={file.id} className="file-item">
                                        <div className="file-info">
                                            <img src={file.preview} alt={file.name} className="file-preview" />
                                            <div className="file-details">
                                                <h4>{file.name}</h4>
                                                <p>{formatFileSize(file.size)}</p>
                                                {file.status === 'compressing' && (
                                                    <div className="file-status compressing">
                                                        Compressing... {Math.round(file.progress)}%
                                                        <div className="file-progress-bar">
                                                            <div className="file-progress-fill" style={{ width: `${file.progress}%` }}></div>
                                                        </div>
                                                    </div>
                                                )}
                                                {file.status === 'completed' && (
                                                    <div className="file-status completed">
                                                        Compressed: {formatFileSize(file.compressedSize)}
                                                        ({file.savings}% saved)
                                                    </div>
                                                )}
                                                {file.status === 'error' && (
                                                    <div className="file-status error">
                                                        Error: {file.error}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        <button 
                                            className="btn" 
                                            onClick={() => removeFile(file.id)}
                                            disabled={isProcessing}
                                        >
                                            Remove
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}

                        {files.length > 0 && (
                            <div style={{ textAlign: 'center', marginTop: '30px' }}>
                                <button 
                                    className="btn" 
                                    onClick={compressImages}
                                    disabled={isProcessing}
                                    style={{ fontSize: '1.2rem', padding: '15px 40px' }}
                                >
                                    {isProcessing ? 'Compressing...' : `Compress ${files.length} Images`}
                                </button>
                            </div>
                        )}

                        {isProcessing && (
                            <div>
                                <div className="progress-bar">
                                    <div className="progress-fill" style={{ width: `${progress}%` }}></div>
                                </div>
                                <div className="status">{status}</div>
                            </div>
                        )}

                        {error && <div className="error">{error}</div>}
                        {status && !isProcessing && !error && <div className="success">{status}</div>}
                    </div>
                </div>
            );
        }

        const rootElement = document.getElementById("root");
        ReactDOM.createRoot(rootElement).render(<ImageCompressor />);
    </script>
</body>
</html>
